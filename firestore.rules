rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper function to check user role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    // Helper function to check if user has any of the roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || hasRole('admin'));
      allow delete: if hasRole('admin');
    }

    // Members collection
    match /members/{memberId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Events collection
    match /events/{eventId} {
      allow read: if true; // Public read for events
      allow create: if hasAnyRole(['admin', 'secretary', 'leader']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Blog posts collection
    match /blogPosts/{postId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Projects collection
    match /projects/{projectId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary', 'leader']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Devotionals collection
    match /devotionals/{devotionalId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Forum categories collection
    match /forumCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Forum topics collection
    match /forumTopics/{topicId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // Forum replies collection
    match /forumReplies/{replyId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // Visitors collection
    match /visitors/{visitorId} {
      allow read: if isAuthenticated();
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Assistidos collection
    match /assistidos/{assistidoId} {
      allow read: if hasAnyRole(['admin', 'secretary', 'professional']);
      allow create: if hasAnyRole(['admin', 'secretary', 'professional']);
      allow update: if hasAnyRole(['admin', 'secretary', 'professional']);
      allow delete: if hasRole('admin');
    }

    // Assistencias collection
    match /assistencias/{assistenciaId} {
      allow read: if hasAnyRole(['admin', 'secretary', 'professional']);
      allow create: if hasAnyRole(['admin', 'secretary', 'professional']);
      allow update: if hasAnyRole(['admin', 'secretary', 'professional']);
      allow delete: if hasRole('admin');
    }

    // Prayer requests collection
    match /prayerRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if hasRole('admin');
    }

    // Notification preferences collection
    match /notificationPreferences/{userId} {
      allow read: if isAuthenticated() && userId == request.auth.uid;
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if isAuthenticated() && userId == request.auth.uid;
      allow delete: if isAuthenticated() && userId == request.auth.uid;
    }

    // User permission overrides collection
    match /userPermissionOverrides/{userId} {
      allow read: if isAuthenticated();
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Role permissions collection
    match /rolePermissions/{roleId} {
      allow read: if isAuthenticated();
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Financial transactions collection
    match /transactions/{transactionId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Home layouts collection
    match /homeLayouts/{layoutId} {
      allow read: if true; // Public read
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Settings collection
    match /settings/{settingId} {
      allow read: if true; // Public read for church info
      allow update: if hasRole('admin');
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated(); // Any authenticated user can create logs
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs should never be deleted
    }

    // ========================================
    // ASSETS COLLECTION (Patrimônio)
    // ========================================
    match /assets/{assetId} {
      // Leitura: usuários autenticados com role admin ou secretary
      allow read: if isAuthenticated() && hasAnyRole(['admin', 'secretary']);

      // Criação: admin e secretary com validação de dados
      allow create: if isAuthenticated() &&
                       hasAnyRole(['admin', 'secretary']) &&
                       // Validação de campos obrigatórios e tipos
                       request.resource.data.name is string &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 200 &&
                       request.resource.data.category is string &&
                       request.resource.data.acquisitionValue >= 0 &&
                       request.resource.data.acquisitionDate is timestamp &&
                       request.resource.data.condition is string &&
                       request.resource.data.status is string &&
                       request.resource.data.location is string &&
                       request.resource.data.location.size() >= 1 &&
                       request.resource.data.location.size() <= 300 &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.updatedAt is timestamp;

      // Edição: admin e secretary com validação de dados
      allow update: if isAuthenticated() &&
                       hasAnyRole(['admin', 'secretary']) &&
                       // Validação de campos obrigatórios e tipos
                       request.resource.data.name is string &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 200 &&
                       request.resource.data.category is string &&
                       request.resource.data.acquisitionValue >= 0 &&
                       request.resource.data.acquisitionDate is timestamp &&
                       request.resource.data.condition is string &&
                       request.resource.data.status is string &&
                       request.resource.data.location is string &&
                       request.resource.data.location.size() >= 1 &&
                       request.resource.data.location.size() <= 300 &&
                       request.resource.data.updatedAt is timestamp;

      // Exclusão: apenas admin
      allow delete: if isAuthenticated() && hasRole('admin');
    }

    // ONG collections
    match /ongSettings/{settingId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasRole('admin');
    }

    match /ongVolunteers/{volunteerId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /ongActivities/{activityId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // PUBLIC PAGE SETTINGS
    // ========================================
    match /publicPageSettings/{configId} {
      allow read: if true; // Public read for public page settings
      allow create: if true; // Allow creation if document doesn't exist
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // ========================================
    // EVENT CONFIRMATIONS
    // ========================================
    match /eventConfirmations/{confirmationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // LIKES (Blog, Comments, etc)
    // ========================================
    match /likes/{likeId} {
      allow read: if true; // Anyone can read likes
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // PROJECT REGISTRATIONS
    // ========================================
    match /projectRegistrations/{registrationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // LIVE STREAMS
    // ========================================
    match /liveStreams/{streamId} {
      allow read: if true; // Public read for live streams
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // LIVE VIEWERS
    // ========================================
    match /liveViewers/{viewerId} {
      allow read: if true; // Anyone can read viewer count
      allow create: if true; // Anyone can register as viewer
      allow update: if true; // Update viewer status
      allow delete: if true; // Remove viewer when leaving
    }

    // ========================================
    // STREAM VIEWERS (Real-time and Historical Counts)
    // ========================================
    match /streamViewers/{streamId} {
      allow read: if true; // Anyone can read viewer statistics

      // Subcollection for current active viewers
      match /viewers/{viewerId} {
        allow read: if true; // Anyone can read current viewer count
        allow create: if true; // Anyone can register as an active viewer
        allow update: if true; // Update viewer heartbeat/status
        allow delete: if true; // Remove viewer when leaving
      }

      // Subcollection for total historical viewers
      match /totalViewers/{viewerId} {
        allow read: if true; // Anyone can read total viewer count
        allow create: if true; // Anyone can be counted as a viewer
        allow update: if true; // Update viewer timestamp
        allow delete: if false; // Don't allow deletion of historical data
      }
    }

    // ========================================
    // COMMENTS (Blog, etc)
    // ========================================
    match /comments/{commentId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // ========================================
    // DEVOTIONAL CATEGORIES
    // ========================================
    match /devotionalCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // DEVOTIONAL PLANS
    // ========================================
    match /devotionalPlans/{planId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // USER DEVOTIONAL PROGRESS
    // ========================================
    match /userDevotionalProgress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
