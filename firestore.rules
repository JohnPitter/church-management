rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isApproved() {
      return isAuthenticated() && getUserData().status == 'approved';
    }

    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isDocOwner() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // USERS
    // ========================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================
    // PUBLIC READ - Write by approved users
    // ========================================
    match /events/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /blogPosts/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /projects/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /devotionals/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /devotionalCategories/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /devotionalPlans/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /eventCategories/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /liveStreams/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /leaders/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /homeLayouts/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /homeSettings/{docId} {
      allow read: if true;
      allow write: if isAdmin() || hasRole('secretary');
    }

    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /publicPageSettings/{docId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // ========================================
    // PUBLIC READ - Auth users can interact
    // ========================================
    match /forumCategories/{docId} {
      allow read: if true;
      allow write: if isApproved();
    }

    match /forumTopics/{docId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isApproved());
      allow delete: if isApproved();
    }

    match /forumReplies/{docId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isApproved());
      allow delete: if isApproved();
    }

    match /comments/{docId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (isDocOwner() || isApproved());
      allow delete: if isApproved();
    }

    match /devotionalComments/{docId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (isDocOwner() || isApproved());
      allow delete: if isApproved();
    }

    match /likes/{docId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow delete: if isDocOwner();
    }

    // ========================================
    // FULLY PUBLIC (Streams/Viewers)
    // ========================================
    match /liveViewers/{docId} {
      allow read, write: if true;
    }

    match /streamViewers/{streamId} {
      allow read: if true;
      match /viewers/{viewerId} {
        allow read, create, update: if true;
        allow delete: if true;
      }
      match /totalViewers/{viewerId} {
        allow read, create, update: if true;
        allow delete: if false;
      }
    }

    // ========================================
    // AUTHENTICATED - CRUD by approved users
    // ========================================
    match /members/{docId} {
      allow read, write: if isApproved();
    }

    match /visitors/{docId} {
      allow read, write: if isApproved();
    }

    match /voluntarios/{docId} {
      allow read: if isAuthenticated();
      allow write: if isApproved();
    }

    // ========================================
    // OWNER-BASED collections
    // ========================================
    match /notificationPreferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /notifications/{docId} {
      allow read: if isAuthenticated() && (isDocOwner() || isApproved());
      allow create: if isApproved();
      allow update: if isDocOwner();
      allow delete: if isApproved();
    }

    match /prayerRequests/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isApproved();
    }

    match /eventConfirmations/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isDocOwner();
    }

    match /projectRegistrations/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isDocOwner();
    }

    match /userDevotionalProgress/{docId} {
      allow read: if isAuthenticated() && (isDocOwner() || isApproved());
      allow create: if isAuthenticated();
      allow update, delete: if isDocOwner();
    }

    match /userPlanProgress/{docId} {
      allow read: if isAuthenticated() && (isDocOwner() || isApproved());
      allow create: if isAuthenticated();
      allow update, delete: if isDocOwner();
    }

    // ========================================
    // FORUM - user-specific
    // ========================================
    match /forumActivities/{docId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isApproved();
    }

    match /forumNotifications/{docId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isDocOwner();
    }

    match /userForumProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwner(userId);
      allow delete: if isApproved();
    }

    // ========================================
    // FINANCIAL - approved users only
    // ========================================
    match /transactions/{docId} {
      allow read, write: if isApproved();
    }

    match /donations/{docId} {
      allow read, write: if isApproved();
    }

    match /budgets/{docId} {
      allow read, write: if isApproved();
    }

    match /financialCategories/{docId} {
      allow read, write: if isApproved();
    }

    match /church_budgets/{docId} {
      allow read, write: if isApproved();
    }

    match /church_categories/{docId} {
      allow read, write: if isApproved();
    }

    match /church_transactions/{docId} {
      allow read, write: if isApproved();
    }

    match /church_donations/{docId} {
      allow read, write: if isApproved();
    }

    match /church_departments/{docId} {
      allow read, write: if isApproved();
    }

    match /church_department_transactions/{docId} {
      allow read, write: if isApproved();
    }

    match /church_department_transfers/{docId} {
      allow read, write: if isApproved();
    }

    // ========================================
    // ONG - approved users only
    // ========================================
    match /ongSettings/{docId} {
      allow read, write: if isApproved();
    }

    match /ongVolunteers/{docId} {
      allow read, write: if isApproved();
    }

    match /ongActivities/{docId} {
      allow read, write: if isApproved();
    }

    match /atividadesONG/{docId} {
      allow read, write: if isApproved();
    }

    match /doacoesONG/{docId} {
      allow read, write: if isApproved();
    }

    match /ongInfo/{docId} {
      allow read, write: if isApproved();
    }

    match /ong_budgets/{docId} {
      allow read, write: if isApproved();
    }

    match /ong_categories/{docId} {
      allow read, write: if isApproved();
    }

    match /ong_transactions/{docId} {
      allow read, write: if isApproved();
    }

    // ========================================
    // ASSISTANCE - approved users only
    // ========================================
    match /assistidos/{docId} {
      allow read, write: if isApproved();
    }

    match /assistencias/{docId} {
      allow read, write: if isApproved();
    }

    match /agendamentosAssistencia/{docId} {
      allow read, write: if isApproved();
    }

    match /profissionaisAssistencia/{docId} {
      allow read, write: if isApproved();
    }

    match /atendimentos/{docId} {
      allow read, write: if isApproved();
    }

    match /professional_help_requests/{docId} {
      allow read: if isAuthenticated() && (
        resource.data.solicitanteId == request.auth.uid ||
        resource.data.destinatarioId == request.auth.uid ||
        isApproved()
      );
      allow create: if isApproved();
      allow update: if isAuthenticated() && (
        resource.data.solicitanteId == request.auth.uid ||
        resource.data.destinatarioId == request.auth.uid ||
        isApproved()
      );
      allow delete: if isApproved();
    }

    match /professional_help_request_comments/{docId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated() && (isDocOwner() || isApproved());
      allow delete: if isApproved();
    }

    match /fichasAcompanhamento/{docId} {
      allow read, write: if isApproved();
      match /sessoes/{sessaoId} {
        allow read, write: if isApproved();
      }
    }

    // ========================================
    // ASSETS - approved users only
    // ========================================
    match /assets/{docId} {
      allow read, write: if isApproved();
    }

    // ========================================
    // PERMISSIONS - approved users only
    // ========================================
    match /rolePermissions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /userPermissionOverrides/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /customRoles/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // AUDIT & LOGS - admin only
    // ========================================
    match /auditLogs/{docId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    match /systemLogs/{docId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if isAdmin();
    }

    match /permissionAudit/{docId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ========================================
    // BACKUPS - admin only
    // ========================================
    match /system_backups/{docId} {
      allow read, write: if isAdmin();
    }

    match /backups/{docId} {
      allow read, write: if isAdmin();
    }

    match /backup_metadata/{docId} {
      allow read, write: if isAdmin();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
