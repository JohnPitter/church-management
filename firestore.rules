rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS - AUTHENTICATION
    // ========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user data from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is approved
    function isApproved() {
      return isAuthenticated() && getUserData().status == 'approved';
    }

    // Check specific role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    // ========================================
    // PERMISSION SYSTEM (CORRIGIDO)
    // ========================================

    // Main permission check function
    function hasPermission(module, action) {
      return getUserData().status == 'approved' &&
             checkUserPermission(getUserData(), module, action);
    }

    // Check user permission with proper priority
    // Priority: 1. Custom grants, 2. Custom revokes block, 3. Role permissions
    function checkUserPermission(userData, module, action) {
      return hasCustomGrant(userData, module, action) ||
             (!hasCustomRevoke(userData, module, action) && hasRolePermission(userData, module, action));
    }

    // Check custom grants - CORRIGIDO: verifica todo o array
    function hasCustomGrant(userData, module, action) {
      return 'customPermissions' in userData &&
             'granted' in userData.customPermissions &&
             userData.customPermissions.granted.size() > 0 &&
             findPermissionInArray(userData.customPermissions.granted, module, action);
    }

    // Check custom revokes - CORRIGIDO: verifica todo o array
    function hasCustomRevoke(userData, module, action) {
      return 'customPermissions' in userData &&
             'revoked' in userData.customPermissions &&
             userData.customPermissions.revoked.size() > 0 &&
             findPermissionInArray(userData.customPermissions.revoked, module, action);
    }

    // CORRIGIDO: Busca permissão em todo o array (até 20 elementos)
    // Firestore Rules não suporta loops, então verificamos explicitamente
    function findPermissionInArray(arr, module, action) {
      return (arr.size() > 0 && arr[0].module == module && action in arr[0].actions) ||
             (arr.size() > 1 && arr[1].module == module && action in arr[1].actions) ||
             (arr.size() > 2 && arr[2].module == module && action in arr[2].actions) ||
             (arr.size() > 3 && arr[3].module == module && action in arr[3].actions) ||
             (arr.size() > 4 && arr[4].module == module && action in arr[4].actions) ||
             (arr.size() > 5 && arr[5].module == module && action in arr[5].actions) ||
             (arr.size() > 6 && arr[6].module == module && action in arr[6].actions) ||
             (arr.size() > 7 && arr[7].module == module && action in arr[7].actions) ||
             (arr.size() > 8 && arr[8].module == module && action in arr[8].actions) ||
             (arr.size() > 9 && arr[9].module == module && action in arr[9].actions) ||
             (arr.size() > 10 && arr[10].module == module && action in arr[10].actions) ||
             (arr.size() > 11 && arr[11].module == module && action in arr[11].actions) ||
             (arr.size() > 12 && arr[12].module == module && action in arr[12].actions) ||
             (arr.size() > 13 && arr[13].module == module && action in arr[13].actions) ||
             (arr.size() > 14 && arr[14].module == module && action in arr[14].actions) ||
             (arr.size() > 15 && arr[15].module == module && action in arr[15].actions) ||
             (arr.size() > 16 && arr[16].module == module && action in arr[16].actions) ||
             (arr.size() > 17 && arr[17].module == module && action in arr[17].actions) ||
             (arr.size() > 18 && arr[18].module == module && action in arr[18].actions) ||
             (arr.size() > 19 && arr[19].module == module && action in arr[19].actions);
    }

    // ========================================
    // ROLE PERMISSIONS (Suporta custom roles)
    // ========================================

    // Check role permissions - suporta roles padrão e custom roles
    function hasRolePermission(userData, module, action) {
      return userData.role == 'admin' ||
             // Custom role: verifica rolePermissions snapshot no documento do usuário
             ('rolePermissions' in userData &&
              userData.rolePermissions != null &&
              userData.rolePermissions.size() > 0 &&
              findPermissionInArray(userData.rolePermissions, module, action)) ||
             // Roles padrão (hardcoded para performance)
             (userData.role == 'secretary' && hasSecretaryPermission(module, action)) ||
             (userData.role == 'leader' && hasLeaderPermission(module, action)) ||
             (userData.role == 'member' && hasMemberPermission(module, action)) ||
             (userData.role == 'professional' && hasProfessionalPermission(module, action)) ||
             (userData.role == 'finance' && hasFinancePermission(module, action));
    }

    // Secretary role permissions - CORRIGIDO: 'finance' ao invés de 'financial'
    function hasSecretaryPermission(module, action) {
      return (module in ['dashboard', 'users', 'members', 'events', 'blog', 'devotionals',
                         'transmissions', 'projects', 'visitors', 'calendar', 'forum',
                         'notifications', 'settings', 'assistance', 'ong', 'leadership',
                         'assets'] &&
              action in ['view', 'create', 'update', 'delete']) ||
             (module == 'members' && action == 'export') ||
             (module == 'visitors' && action == 'export') ||
             (module == 'finance' && action == 'view');
    }

    // Leader role permissions
    function hasLeaderPermission(module, action) {
      return (module in ['dashboard', 'members', 'events', 'projects', 'calendar',
                         'blog', 'devotionals', 'forum'] &&
              action == 'view') ||
             (module in ['events', 'projects'] && action in ['create', 'update']);
    }

    // Member role permissions
    function hasMemberPermission(module, action) {
      return module in ['dashboard', 'events', 'blog', 'devotionals', 'transmissions',
                        'projects', 'forum', 'calendar', 'leadership'] &&
             action == 'view';
    }

    // Professional role permissions
    function hasProfessionalPermission(module, action) {
      return (module in ['dashboard', 'members', 'calendar', 'reports'] &&
              action == 'view') ||
             (module == 'assistance' && action in ['view', 'create', 'update']);
    }

    // Finance role permissions - CORRIGIDO: 'finance' ao invés de 'financial'
    function hasFinancePermission(module, action) {
      return (module in ['dashboard', 'members', 'calendar'] && action == 'view') ||
             (module == 'finance' && action in ['view', 'create', 'update', 'delete', 'export', 'manage']) ||
             (module == 'donations' && action in ['view', 'create', 'update', 'delete', 'export']) ||
             (module == 'reports' && action in ['view', 'export']);
    }

    // ========================================
    // COLLECTION RULES
    // ========================================

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || hasRole('admin'));
      allow delete: if hasRole('admin');
    }

    // Members collection
    match /members/{memberId} {
      allow read: if isAuthenticated() && hasPermission('members', 'view');
      allow create: if isAuthenticated() && hasPermission('members', 'create');
      allow update: if isAuthenticated() && hasPermission('members', 'update');
      allow delete: if isAuthenticated() && hasPermission('members', 'delete');
    }

    // Events collection
    match /events/{eventId} {
      allow read: if true; // Public read for events
      allow create: if isAuthenticated() && hasPermission('events', 'create');
      allow update: if isAuthenticated() && hasPermission('events', 'update');
      allow delete: if isAuthenticated() && hasPermission('events', 'delete');
    }

    // Blog posts collection
    match /blogPosts/{postId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated() && hasPermission('blog', 'create');
      allow update: if isAuthenticated() && hasPermission('blog', 'update');
      allow delete: if isAuthenticated() && hasPermission('blog', 'delete');
    }

    // Projects collection - MIGRADO para hasPermission
    match /projects/{projectId} {
      allow read: if true; // Public read
      allow create: if isApproved() && hasPermission('projects', 'create');
      allow update: if isApproved() && hasPermission('projects', 'update');
      allow delete: if isApproved() && hasPermission('projects', 'delete');
    }

    // Devotionals collection - MIGRADO para hasPermission
    match /devotionals/{devotionalId} {
      allow read: if true; // Public read
      allow create: if isApproved() && hasPermission('devotionals', 'create');
      allow update: if isApproved() && hasPermission('devotionals', 'update');
      allow delete: if isApproved() && hasPermission('devotionals', 'delete');
    }

    // Forum categories collection - MIGRADO para hasPermission
    match /forumCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if isApproved() && hasPermission('forum', 'create');
      allow update: if isApproved() && hasPermission('forum', 'update');
      allow delete: if isApproved() && hasPermission('forum', 'delete');
    }

    // Forum topics collection - MIGRADO para hasPermission
    match /forumTopics/{topicId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated(); // Qualquer usuário autenticado pode criar tópicos
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        hasPermission('forum', 'update')
      );
      allow delete: if isApproved() && hasPermission('forum', 'delete');
    }

    // Forum replies collection - MIGRADO para hasPermission
    match /forumReplies/{replyId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated(); // Qualquer usuário autenticado pode responder
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        hasPermission('forum', 'update')
      );
      allow delete: if isApproved() && hasPermission('forum', 'delete');
    }

    // Visitors collection
    match /visitors/{visitorId} {
      allow read: if isAuthenticated() && hasPermission('visitors', 'view');
      allow create: if isAuthenticated() && hasPermission('visitors', 'create');
      allow update: if isAuthenticated() && hasPermission('visitors', 'update');
      allow delete: if isAuthenticated() && hasPermission('visitors', 'delete');
    }

    // Assistidos collection
    match /assistidos/{assistidoId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // Assistencias collection
    match /assistencias/{assistenciaId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // Agendamentos Assistencia collection
    match /agendamentosAssistencia/{agendamentoId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // Prayer requests collection - Mantém lógica especial (qualquer usuário pode criar)
    match /prayerRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Qualquer usuário autenticado pode criar pedidos de oração
      allow update: if isApproved() && hasPermission('notifications', 'update');
      allow delete: if isApproved() && hasPermission('notifications', 'delete');
    }

    // Notifications collection - MIGRADO para hasPermission
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('notifications', 'view')
      );
      allow create: if isApproved() && hasPermission('notifications', 'create');
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isApproved() && hasPermission('notifications', 'delete');
    }

    // Notification preferences collection
    match /notificationPreferences/{userId} {
      allow read: if isAuthenticated() && userId == request.auth.uid;
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if isAuthenticated() && userId == request.auth.uid;
      allow delete: if isAuthenticated() && userId == request.auth.uid;
    }

    // User permission overrides collection - MIGRADO para hasPermission
    match /userPermissionOverrides/{userId} {
      allow read: if isAuthenticated();
      allow create: if isApproved() && hasPermission('permissions', 'create');
      allow update: if isApproved() && hasPermission('permissions', 'update');
      allow delete: if isApproved() && hasPermission('permissions', 'delete');
    }

    // Role permissions collection - MIGRADO para hasPermission
    match /rolePermissions/{roleId} {
      allow read: if isAuthenticated();
      allow create: if isApproved() && hasPermission('permissions', 'create');
      allow update: if isApproved() && hasPermission('permissions', 'update');
      allow delete: if isApproved() && hasPermission('permissions', 'delete');
    }

    // Financial transactions collection - CORRIGIDO: 'finance' ao invés de 'financial'
    match /transactions/{transactionId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    // Donations collection - CORRIGIDO: usa módulo 'donations'
    match /donations/{donationId} {
      allow read: if isApproved() && hasPermission('donations', 'view');
      allow create: if isApproved() && hasPermission('donations', 'create');
      allow update: if isApproved() && hasPermission('donations', 'update');
      allow delete: if isApproved() && hasPermission('donations', 'delete');
    }

    // Home layouts collection
    match /homeLayouts/{layoutId} {
      allow read: if true; // Public read
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Settings collection
    match /settings/{settingId} {
      allow read: if true; // Public read for church info
      allow update: if hasRole('admin');
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated(); // Any authenticated user can create logs
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs should never be deleted
    }

    // System logs collection
    match /systemLogs/{logId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated(); // Any authenticated user can create logs
      allow update: if false; // Logs are immutable
      allow delete: if hasRole('admin'); // Only admin can delete logs
    }

    // ========================================
    // ASSETS COLLECTION (Patrimônio) - MIGRADO para hasPermission
    // ========================================
    match /assets/{assetId} {
      // Leitura: usuários com permissão assets.view
      allow read: if isApproved() && hasPermission('assets', 'view');

      // Criação: usuários com permissão assets.create + validação de dados
      allow create: if isApproved() &&
                       hasPermission('assets', 'create') &&
                       // Validação de campos obrigatórios e tipos
                       request.resource.data.name is string &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 200 &&
                       request.resource.data.category is string &&
                       request.resource.data.acquisitionValue >= 0 &&
                       request.resource.data.acquisitionDate is timestamp &&
                       request.resource.data.condition is string &&
                       request.resource.data.status is string &&
                       request.resource.data.location is string &&
                       request.resource.data.location.size() >= 1 &&
                       request.resource.data.location.size() <= 300 &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.updatedAt is timestamp;

      // Edição: usuários com permissão assets.update + validação de dados
      allow update: if isApproved() &&
                       hasPermission('assets', 'update') &&
                       // Validação de campos obrigatórios e tipos
                       request.resource.data.name is string &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 200 &&
                       request.resource.data.category is string &&
                       request.resource.data.acquisitionValue >= 0 &&
                       request.resource.data.acquisitionDate is timestamp &&
                       request.resource.data.condition is string &&
                       request.resource.data.status is string &&
                       request.resource.data.location is string &&
                       request.resource.data.location.size() >= 1 &&
                       request.resource.data.location.size() <= 300 &&
                       request.resource.data.updatedAt is timestamp;

      // Exclusão: usuários com permissão assets.delete
      allow delete: if isApproved() && hasPermission('assets', 'delete');
    }

    // ========================================
    // ONG COLLECTIONS - MIGRADO para hasPermission
    // ========================================
    match /ongSettings/{settingId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /ongVolunteers/{volunteerId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /voluntarios/{volunteerId} {
      allow read: if isAuthenticated(); // Allow all authenticated users to read (for calendar birthdays)
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /ongActivities/{activityId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /atividadesONG/{activityId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /doacoesONG/{donationId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /ongInfo/{infoId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    // ========================================
    // PUBLIC PAGE SETTINGS
    // ========================================
    match /publicPageSettings/{configId} {
      allow read: if true; // Public read for public page settings
      allow create: if true; // Allow creation if document doesn't exist
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // ========================================
    // EVENT CONFIRMATIONS
    // ========================================
    match /eventConfirmations/{confirmationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // LIKES (Blog, Comments, etc)
    // ========================================
    match /likes/{likeId} {
      allow read: if true; // Anyone can read likes
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // PROJECT REGISTRATIONS
    // ========================================
    match /projectRegistrations/{registrationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // LIVE STREAMS - MIGRADO para hasPermission
    // ========================================
    match /liveStreams/{streamId} {
      allow read: if true; // Public read for live streams
      allow create: if isApproved() && hasPermission('transmissions', 'create');
      allow update: if isApproved() && hasPermission('transmissions', 'update');
      allow delete: if isApproved() && hasPermission('transmissions', 'delete');
    }

    // ========================================
    // LIVE VIEWERS
    // ========================================
    match /liveViewers/{viewerId} {
      allow read: if true; // Anyone can read viewer count
      allow create: if true; // Anyone can register as viewer
      allow update: if true; // Update viewer status
      allow delete: if true; // Remove viewer when leaving
    }

    // ========================================
    // STREAM VIEWERS (Real-time and Historical Counts)
    // ========================================
    match /streamViewers/{streamId} {
      allow read: if true; // Anyone can read viewer statistics

      // Subcollection for current active viewers
      match /viewers/{viewerId} {
        allow read: if true; // Anyone can read current viewer count
        allow create: if true; // Anyone can register as an active viewer
        allow update: if true; // Update viewer heartbeat/status
        allow delete: if true; // Remove viewer when leaving
      }

      // Subcollection for total historical viewers
      match /totalViewers/{viewerId} {
        allow read: if true; // Anyone can read total viewer count
        allow create: if true; // Anyone can be counted as a viewer
        allow update: if true; // Update viewer timestamp
        allow delete: if false; // Don't allow deletion of historical data
      }
    }

    // ========================================
    // COMMENTS (Blog, etc) - MIGRADO para hasPermission
    // ========================================
    match /comments/{commentId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated(); // Qualquer usuário autenticado pode comentar
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('blog', 'update')
      );
      allow delete: if isApproved() && hasPermission('blog', 'delete');
    }

    // ========================================
    // DEVOTIONAL CATEGORIES - MIGRADO para hasPermission
    // ========================================
    match /devotionalCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if isApproved() && hasPermission('devotionals', 'create');
      allow update: if isApproved() && hasPermission('devotionals', 'update');
      allow delete: if isApproved() && hasPermission('devotionals', 'delete');
    }

    // ========================================
    // DEVOTIONAL PLANS - MIGRADO para hasPermission
    // ========================================
    match /devotionalPlans/{planId} {
      allow read: if true; // Public read
      allow create: if isApproved() && hasPermission('devotionals', 'create');
      allow update: if isApproved() && hasPermission('devotionals', 'update');
      allow delete: if isApproved() && hasPermission('devotionals', 'delete');
    }

    // ========================================
    // USER DEVOTIONAL PROGRESS
    // ========================================
    match /userDevotionalProgress/{progressId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('devotionals', 'view')
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // FINANCIAL COLLECTIONS - CORRIGIDO: 'finance' ao invés de 'financial'
    // ========================================
    match /budgets/{budgetId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /financialCategories/{categoryId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /church_budgets/{budgetId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /church_categories/{categoryId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /church_transactions/{transactionId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /church_donations/{donationId} {
      allow read: if isApproved() && hasPermission('donations', 'view');
      allow create: if isApproved() && hasPermission('donations', 'create');
      allow update: if isApproved() && hasPermission('donations', 'update');
      allow delete: if isApproved() && hasPermission('donations', 'delete');
    }

    match /church_departments/{deptId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /church_department_transactions/{transactionId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    match /church_department_transfers/{transferId} {
      allow read: if isApproved() && hasPermission('finance', 'view');
      allow create: if isApproved() && hasPermission('finance', 'create');
      allow update: if isApproved() && hasPermission('finance', 'update');
      allow delete: if isApproved() && hasPermission('finance', 'delete');
    }

    // ONG Financial collections - MIGRADO para hasPermission
    match /ong_budgets/{budgetId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /ong_categories/{categoryId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    match /ong_transactions/{transactionId} {
      allow read: if isApproved() && hasPermission('ong', 'view');
      allow create: if isApproved() && hasPermission('ong', 'create');
      allow update: if isApproved() && hasPermission('ong', 'update');
      allow delete: if isApproved() && hasPermission('ong', 'delete');
    }

    // ========================================
    // ASSISTANCE COLLECTIONS (Additional)
    // ========================================
    match /profissionaisAssistencia/{profissionalId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    match /atendimentos/{atendimentoId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // ========================================
    // FORUM COLLECTIONS - MIGRADO para hasPermission
    // ========================================
    match /forumActivities/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isApproved() && hasPermission('forum', 'update');
      allow delete: if isApproved() && hasPermission('forum', 'delete');
    }

    match /forumNotifications/{notifId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /userForumProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if isAuthenticated() && userId == request.auth.uid;
      allow delete: if isApproved() && hasPermission('forum', 'delete');
    }

    // ========================================
    // EVENT COLLECTIONS - MIGRADO para hasPermission
    // ========================================
    match /eventCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if isApproved() && hasPermission('events', 'create');
      allow update: if isApproved() && hasPermission('events', 'update');
      allow delete: if isApproved() && hasPermission('events', 'delete');
    }

    // ========================================
    // DEVOTIONAL COLLECTIONS - MIGRADO para hasPermission
    // ========================================
    match /devotionalComments/{commentId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated(); // Qualquer usuário autenticado pode comentar
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('devotionals', 'update')
      );
      allow delete: if isApproved() && hasPermission('devotionals', 'delete');
    }

    match /userPlanProgress/{progressId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('devotionals', 'view')
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // CUSTOM ROLES - MIGRADO para hasPermission
    // ========================================
    match /customRoles/{roleId} {
      allow read: if isAuthenticated();
      allow create: if isApproved() && hasPermission('permissions', 'create');
      allow update: if isApproved() && hasPermission('permissions', 'update');
      allow delete: if isApproved() && hasPermission('permissions', 'delete');
    }

    // ========================================
    // PERMISSION AUDIT LOGS (Nova collection)
    // ========================================
    match /permissionAudit/{auditId} {
      allow read: if isApproved() && hasPermission('audit', 'view');
      allow create: if isAuthenticated(); // Sistema cria automaticamente
      allow update: if false; // Logs são imutáveis
      allow delete: if false; // Logs nunca devem ser deletados
    }

    // ========================================
    // PROFESSIONAL HELP REQUESTS - MIGRADO para hasPermission
    // ========================================
    match /professional_help_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.solicitanteId == request.auth.uid ||
        resource.data.destinatarioId == request.auth.uid ||
        hasPermission('assistance', 'view')
      );
      allow create: if isApproved() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && (
        resource.data.solicitanteId == request.auth.uid ||
        resource.data.destinatarioId == request.auth.uid ||
        hasPermission('assistance', 'update')
      );
      allow delete: if isApproved() && hasPermission('assistance', 'delete');
    }

    match /professional_help_request_comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('assistance', 'update')
      );
      allow delete: if isApproved() && hasPermission('assistance', 'delete');
    }

    // ========================================
    // FICHAS DE ACOMPANHAMENTO (ASSISTANCE) - MIGRADO para hasPermission
    // ========================================
    match /fichasAcompanhamento/{fichaId} {
      allow read: if isApproved() && hasPermission('assistance', 'view');
      allow create: if isApproved() && hasPermission('assistance', 'create');
      allow update: if isApproved() && hasPermission('assistance', 'update');
      allow delete: if isApproved() && hasPermission('assistance', 'delete');

      // Subcoleção de sessões
      match /sessoes/{sessaoId} {
        allow read: if isApproved() && hasPermission('assistance', 'view');
        allow write: if isApproved() && hasPermission('assistance', 'update');
      }
    }

    // ========================================
    // BACKUP COLLECTIONS
    // ========================================
    match /system_backups/{backupId} {
      allow read: if hasRole('admin');
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    match /backups/{backupId} {
      allow read: if hasRole('admin');
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    match /backup_metadata/{metadataId} {
      allow read: if hasRole('admin');
      allow write: if hasRole('admin');
    }

    // Home Settings - Simple configuration
    match /homeSettings/{document} {
      allow read: if true; // Anyone can read
      allow write: if hasRole('admin') || hasRole('secretary');
    }

    // ========================================
    // LEADERSHIP COLLECTION
    // ========================================
    match /leaders/{leaderId} {
      allow read: if true; // Public read for leadership page
      allow create: if isAuthenticated() && hasPermission('leadership', 'create');
      allow update: if isAuthenticated() && hasPermission('leadership', 'update');
      allow delete: if isAuthenticated() && hasPermission('leadership', 'delete');
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }

  }
}
