rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper function to check user role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    // Helper function to check if user has any of the roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }

    // Helper function to check if user has specific permission (atomic check)
    function hasPermission(module, action) {
      return isAuthenticated() &&
             getUserData().status == 'approved' &&
             hasModuleAction(getUserData().role, module, action, getUserData());
    }

    // Helper function to check if role has permission for module and action
    function hasModuleAction(role, module, action, userData) {
      // Check custom overrides first
      return hasCustomGrant(userData, module, action) ||
             (hasRolePermission(role, module, action) && !hasCustomRevoke(userData, module, action));
    }

    // Check if user has custom grant for this permission
    function hasCustomGrant(userData, module, action) {
      return 'customPermissions' in userData &&
             'granted' in userData.customPermissions &&
             hasGrantedPermission(userData.customPermissions.granted, module, action);
    }

    // Check if granted permissions array contains the permission
    function hasGrantedPermission(granted, module, action) {
      return granted.size() > 0 &&
             granted[0].module == module &&
             action in granted[0].actions;
    }

    // Check if user has custom revoke for this permission
    function hasCustomRevoke(userData, module, action) {
      return 'customPermissions' in userData &&
             'revoked' in userData.customPermissions &&
             hasRevokedPermission(userData.customPermissions.revoked, module, action);
    }

    // Check if revoked permissions array contains the permission
    function hasRevokedPermission(revoked, module, action) {
      return revoked.size() > 0 &&
             revoked[0].module == module &&
             action in revoked[0].actions;
    }

    // Check if role has permission for module and action
    function hasRolePermission(role, module, action) {
      return role == 'admin' ||
             (role == 'secretary' && hasSecretaryPermission(module, action)) ||
             (role == 'leader' && hasLeaderPermission(module, action)) ||
             (role == 'member' && hasMemberPermission(module, action)) ||
             (role == 'professional' && hasProfessionalPermission(module, action)) ||
             (role == 'finance' && hasFinancePermission(module, action));
    }

    // Secretary role permissions
    function hasSecretaryPermission(module, action) {
      return (module in ['dashboard', 'users', 'members', 'events', 'blog', 'devotionals',
                         'projects', 'visitors', 'prayer-requests', 'forum', 'notifications',
                         'settings', 'assistance', 'ong'] &&
              action in ['view', 'create', 'update', 'delete']) ||
             (module == 'financial' && action == 'view');
    }

    // Leader role permissions
    function hasLeaderPermission(module, action) {
      return module in ['dashboard', 'events', 'prayer-requests', 'members', 'blog',
                        'devotionals', 'forum', 'projects'] &&
             action in ['view', 'create', 'update'];
    }

    // Member role permissions
    function hasMemberPermission(module, action) {
      return module in ['dashboard', 'events', 'blog', 'devotionals', 'forum', 'prayer-requests'] &&
             action == 'view';
    }

    // Professional role permissions
    function hasProfessionalPermission(module, action) {
      return module in ['dashboard', 'assistance'] &&
             action in ['view', 'create', 'update'];
    }

    // Finance role permissions
    function hasFinancePermission(module, action) {
      return module in ['dashboard', 'financial'] &&
             action in ['view', 'create', 'update', 'delete', 'export'];
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || hasRole('admin'));
      allow delete: if hasRole('admin');
    }

    // Members collection
    match /members/{memberId} {
      allow read: if isAuthenticated() && hasPermission('members', 'view');
      allow create: if isAuthenticated() && hasPermission('members', 'create');
      allow update: if isAuthenticated() && hasPermission('members', 'update');
      allow delete: if isAuthenticated() && hasPermission('members', 'delete');
    }

    // Events collection
    match /events/{eventId} {
      allow read: if true; // Public read for events
      allow create: if isAuthenticated() && hasPermission('events', 'create');
      allow update: if isAuthenticated() && hasPermission('events', 'update');
      allow delete: if isAuthenticated() && hasPermission('events', 'delete');
    }

    // Blog posts collection
    match /blogPosts/{postId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated() && hasPermission('blog', 'create');
      allow update: if isAuthenticated() && hasPermission('blog', 'update');
      allow delete: if isAuthenticated() && hasPermission('blog', 'delete');
    }

    // Projects collection
    match /projects/{projectId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary', 'leader']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Devotionals collection
    match /devotionals/{devotionalId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Forum categories collection
    match /forumCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Forum topics collection
    match /forumTopics/{topicId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // Forum replies collection
    match /forumReplies/{replyId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // Visitors collection
    match /visitors/{visitorId} {
      allow read: if isAuthenticated() && hasPermission('visitors', 'view');
      allow create: if isAuthenticated() && hasPermission('visitors', 'create');
      allow update: if isAuthenticated() && hasPermission('visitors', 'update');
      allow delete: if isAuthenticated() && hasPermission('visitors', 'delete');
    }

    // Assistidos collection
    match /assistidos/{assistidoId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // Assistencias collection
    match /assistencias/{assistenciaId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // Agendamentos Assistencia collection
    match /agendamentosAssistencia/{agendamentoId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // Prayer requests collection
    match /prayerRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if hasRole('admin');
    }

    // Notification preferences collection
    match /notificationPreferences/{userId} {
      allow read: if isAuthenticated() && userId == request.auth.uid;
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if isAuthenticated() && userId == request.auth.uid;
      allow delete: if isAuthenticated() && userId == request.auth.uid;
    }

    // User permission overrides collection
    match /userPermissionOverrides/{userId} {
      allow read: if isAuthenticated();
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Role permissions collection
    match /rolePermissions/{roleId} {
      allow read: if isAuthenticated();
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Financial transactions collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    // Donations collection
    match /donations/{donationId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    // Home layouts collection
    match /homeLayouts/{layoutId} {
      allow read: if true; // Public read
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // Settings collection
    match /settings/{settingId} {
      allow read: if true; // Public read for church info
      allow update: if hasRole('admin');
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated(); // Any authenticated user can create logs
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs should never be deleted
    }

    // System logs collection
    match /systemLogs/{logId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated(); // Any authenticated user can create logs
      allow update: if false; // Logs are immutable
      allow delete: if hasRole('admin'); // Only admin can delete logs
    }

    // ========================================
    // ASSETS COLLECTION (Patrimônio)
    // ========================================
    match /assets/{assetId} {
      // Leitura: usuários autenticados com role admin ou secretary
      allow read: if isAuthenticated() && hasAnyRole(['admin', 'secretary']);

      // Criação: admin e secretary com validação de dados
      allow create: if isAuthenticated() &&
                       hasAnyRole(['admin', 'secretary']) &&
                       // Validação de campos obrigatórios e tipos
                       request.resource.data.name is string &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 200 &&
                       request.resource.data.category is string &&
                       request.resource.data.acquisitionValue >= 0 &&
                       request.resource.data.acquisitionDate is timestamp &&
                       request.resource.data.condition is string &&
                       request.resource.data.status is string &&
                       request.resource.data.location is string &&
                       request.resource.data.location.size() >= 1 &&
                       request.resource.data.location.size() <= 300 &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.updatedAt is timestamp;

      // Edição: admin e secretary com validação de dados
      allow update: if isAuthenticated() &&
                       hasAnyRole(['admin', 'secretary']) &&
                       // Validação de campos obrigatórios e tipos
                       request.resource.data.name is string &&
                       request.resource.data.name.size() >= 2 &&
                       request.resource.data.name.size() <= 200 &&
                       request.resource.data.category is string &&
                       request.resource.data.acquisitionValue >= 0 &&
                       request.resource.data.acquisitionDate is timestamp &&
                       request.resource.data.condition is string &&
                       request.resource.data.status is string &&
                       request.resource.data.location is string &&
                       request.resource.data.location.size() >= 1 &&
                       request.resource.data.location.size() <= 300 &&
                       request.resource.data.updatedAt is timestamp;

      // Exclusão: apenas admin
      allow delete: if isAuthenticated() && hasRole('admin');
    }

    // ONG collections
    match /ongSettings/{settingId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasRole('admin');
    }

    match /ongVolunteers/{volunteerId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /voluntarios/{volunteerId} {
      allow read: if isAuthenticated(); // Allow all authenticated users to read (for calendar birthdays)
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /ongActivities/{activityId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /atividadesONG/{activityId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /doacoesONG/{donationId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /ongInfo/{infoId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // ========================================
    // PUBLIC PAGE SETTINGS
    // ========================================
    match /publicPageSettings/{configId} {
      allow read: if true; // Public read for public page settings
      allow create: if true; // Allow creation if document doesn't exist
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // ========================================
    // EVENT CONFIRMATIONS
    // ========================================
    match /eventConfirmations/{confirmationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // LIKES (Blog, Comments, etc)
    // ========================================
    match /likes/{likeId} {
      allow read: if true; // Anyone can read likes
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // PROJECT REGISTRATIONS
    // ========================================
    match /projectRegistrations/{registrationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // LIVE STREAMS
    // ========================================
    match /liveStreams/{streamId} {
      allow read: if true; // Public read for live streams
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // LIVE VIEWERS
    // ========================================
    match /liveViewers/{viewerId} {
      allow read: if true; // Anyone can read viewer count
      allow create: if true; // Anyone can register as viewer
      allow update: if true; // Update viewer status
      allow delete: if true; // Remove viewer when leaving
    }

    // ========================================
    // STREAM VIEWERS (Real-time and Historical Counts)
    // ========================================
    match /streamViewers/{streamId} {
      allow read: if true; // Anyone can read viewer statistics

      // Subcollection for current active viewers
      match /viewers/{viewerId} {
        allow read: if true; // Anyone can read current viewer count
        allow create: if true; // Anyone can register as an active viewer
        allow update: if true; // Update viewer heartbeat/status
        allow delete: if true; // Remove viewer when leaving
      }

      // Subcollection for total historical viewers
      match /totalViewers/{viewerId} {
        allow read: if true; // Anyone can read total viewer count
        allow create: if true; // Anyone can be counted as a viewer
        allow update: if true; // Update viewer timestamp
        allow delete: if false; // Don't allow deletion of historical data
      }
    }

    // ========================================
    // COMMENTS (Blog, etc)
    // ========================================
    match /comments/{commentId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // ========================================
    // DEVOTIONAL CATEGORIES
    // ========================================
    match /devotionalCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // DEVOTIONAL PLANS
    // ========================================
    match /devotionalPlans/{planId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // USER DEVOTIONAL PROGRESS
    // ========================================
    match /userDevotionalProgress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // FINANCIAL COLLECTIONS (Additional)
    // ========================================
    match /budgets/{budgetId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /financialCategories/{categoryId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_budgets/{budgetId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_categories/{categoryId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_transactions/{transactionId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_donations/{donationId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_departments/{deptId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_department_transactions/{transactionId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /church_department_transfers/{transferId} {
      allow read: if isAuthenticated() && hasPermission('financial', 'view');
      allow create: if isAuthenticated() && hasPermission('financial', 'create');
      allow update: if isAuthenticated() && hasPermission('financial', 'update');
      allow delete: if isAuthenticated() && hasPermission('financial', 'delete');
    }

    match /ong_budgets/{budgetId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /ong_categories/{categoryId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    match /ong_transactions/{transactionId} {
      allow read: if hasAnyRole(['admin', 'secretary']);
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // ASSISTANCE COLLECTIONS (Additional)
    // ========================================
    match /profissionaisAssistencia/{profissionalId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    match /atendimentos/{atendimentoId} {
      allow read: if isAuthenticated() && hasPermission('assistance', 'view');
      allow create: if isAuthenticated() && hasPermission('assistance', 'create');
      allow update: if isAuthenticated() && hasPermission('assistance', 'update');
      allow delete: if isAuthenticated() && hasPermission('assistance', 'delete');
    }

    // ========================================
    // FORUM COLLECTIONS (Additional)
    // ========================================
    match /forumActivities/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    match /forumNotifications/{notifId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /userForumProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if isAuthenticated() && userId == request.auth.uid;
      allow delete: if hasRole('admin');
    }

    // ========================================
    // EVENT COLLECTIONS (Additional)
    // ========================================
    match /eventCategories/{categoryId} {
      allow read: if true; // Public read
      allow create: if hasAnyRole(['admin', 'secretary']);
      allow update: if hasAnyRole(['admin', 'secretary']);
      allow delete: if hasRole('admin');
    }

    // ========================================
    // DEVOTIONAL COLLECTIONS (Additional)
    // ========================================
    match /devotionalComments/{commentId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    match /userPlanProgress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // CUSTOM ROLES
    // ========================================
    match /customRoles/{roleId} {
      allow read: if isAuthenticated();
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    // ========================================
    // PROFESSIONAL HELP REQUESTS
    // ========================================
    match /professional_help_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.solicitanteId == request.auth.uid ||
        resource.data.destinatarioId == request.auth.uid ||
        hasAnyRole(['admin', 'secretary', 'professional'])
      );
      allow create: if isAuthenticated() && hasAnyRole(['admin', 'secretary', 'professional']);
      allow update: if isAuthenticated() && (
        resource.data.solicitanteId == request.auth.uid ||
        resource.data.destinatarioId == request.auth.uid ||
        hasAnyRole(['admin', 'secretary', 'professional'])
      );
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    match /professional_help_request_comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || hasAnyRole(['admin', 'secretary']));
      allow delete: if hasAnyRole(['admin', 'secretary']);
    }

    // ========================================
    // BACKUP COLLECTIONS
    // ========================================
    match /backups/{backupId} {
      allow read: if hasRole('admin');
      allow create: if hasRole('admin');
      allow update: if hasRole('admin');
      allow delete: if hasRole('admin');
    }

    match /backup_metadata/{metadataId} {
      allow read: if hasRole('admin');
      allow write: if hasRole('admin');
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
